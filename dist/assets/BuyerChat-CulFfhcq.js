import{h as _,a as xe,r as t,u as he,k as pe,l as ge,b as y,j as e,c as je,M as ve,n as Ne,e as $,v as ye,m as f}from"./index-3erXb_RQ.js";import{u as fe,d as V,E as be,j as F,k as L,l as U,V as B,M as we}from"./Layout-VIpD5h--.js";const Se=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],Ce=_("chevron-left",Se);const ke=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],Qe=_("star",ke),{avatar:b,defaultProduct:Me}=je,Ee=[Me],Re=m=>new Date(m).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}).toLowerCase();function Xe(){xe();const[m,w]=t.useState(0),{token:S,user:q}=he(),x=JSON.parse(q),[h,C]=t.useState(""),[r,A]=t.useState(!1),[O,p]=t.useState(!1),[k,Q]=t.useState("Voice Narration"),[M,E]=t.useState(!1),R=t.useRef(null),g=t.useRef([]),[z,X]=t.useState(!1),[c,J]=t.useState(!1),u=pe(),{productId:K,sellerId:H,buyerId:G}=ge(),[o,W]=t.useState([]),[i,Y]=t.useState(),[Z,ee]=t.useState(),[se,ae]=t.useState(),{mutate:te,isPending:ze,isError:Te,error:Pe,data:De}=y({mutationFn:s=>$.post(ye,s),onSuccess:s=>{s?.data&&(console.log(s),ae(s?.data?.voiceDuration),ee(s?.data?.voiceUrl))},onError:s=>{console.log(s)}});let j=[];const{mutate:ie,isPending:Ie,isError:$e,error:Ve,isSuccess:Fe,data:l}=y({mutationFn:s=>$.post(`${f}`,s),onSuccess:s=>{console.log(s),Y(s?.data?.id),j=[...s?.data?.product?.images.map(a=>a.url)],console.log(j),W(s?.data?.product?.images.length>0?j:Ee)},onError:s=>{console.log(s)}});t.useEffect(()=>{ie({participantIds:[H,G],productId:K,initialMessage:"Hello"})},[]);const ne=async s=>{const a=await fetch(`https://afomo-xagx.onrender.com/api/${f}${s}/messages`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`}});if(!a.ok)throw new Error("Failed to fetch messages");return a.json()},{data:re=[],isLoading:Le,isPending:Ue}=fe({queryKey:["messages",i],queryFn:()=>ne(i),enabled:!!i}),v=y({mutationFn:async s=>{const a=await fetch(`https://afomo-xagx.onrender.com/api/${f}${i}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify(s)});if(!a.ok)throw new Error("Send failed");return a.json()},onMutate:async s=>(await u.cancelQueries({queryKey:["messages",i]}),{previousMessages:u.getQueryData(["messages",i])}),onError:(s,a,n)=>{console.log(s),u.setQueryData(["messages",i],n.previousMessages)},onSuccess:s=>{u.invalidateQueries({queryKey:["messages",i]}),console.log("Server returned:",s)}}),ce=()=>{h.trim()&&(v.mutate({content:h,messageType:"TEXT"}),C(""))},oe=s=>Q(s),d=t.useRef(null),T=t.useRef(0),P=new Array(26).fill(1),le=()=>w(s=>(s+1)%o.length),N=()=>w(s=>(s-1+o.length)%o.length),de=s=>T.current=s.touches[0].clientX,me=s=>{const a=T.current-s.changedTouches[0].clientX;a>50&&le(),a<-50&&N()},D=()=>{d.current&&(r?d.current.pause():d.current.play(),A(!r))},ue=async()=>{if(M){R.current.stop(),v.mutate({messageType:"VOICE",voiceUrl:Z,voiceDuration:se}),E(!1);return}try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),a=new MediaRecorder(s);R.current=a,g.current=[],a.ondataavailable=n=>{n.data.size>0&&g.current.push(n.data)},a.onstop=()=>{const n=new Blob(g.current,{type:"audio/webm"}),_e=URL.createObjectURL(n),I=new FormData;I.append("voice",n,"recording.webm");const qe={voice:n};te(I)},a.start(),E(!0)}catch(s){console.log(s),alert("Microphone permission denied")}};return e.jsxs("div",{className:"container px-0",style:{maxWidth:420},children:[x?.accountType==="BUYER"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex align-items-center p-3 border-bottom",children:[e.jsx("button",{className:"btn btn-sm rounded-circle bg-dark ",onClick:N,style:{opacity:.7},children:e.jsx(Ce,{size:22,className:"text-white"})}),e.jsx("h6",{className:"fw-bold mb-0 flex-grow-1 text-center",children:"Duplex Store & Boutique"}),e.jsx("button",{className:"btn btn-sm rounded-circle bg-dark ",onClick:N,style:{opacity:.7},children:e.jsx(V,{size:22,className:"text-white"})})]}),e.jsxs("div",{className:"position-relative",onTouchStart:de,onTouchEnd:me,children:[e.jsx("img",{src:o[m],className:"w-100 carousel-img",alt:""}),e.jsx("div",{className:"carousel-dots",children:o.map((s,a)=>e.jsx("span",{className:a===m?"active":""},a))}),e.jsx("span",{className:"badge bg-primary price-badge",children:l?.data?.product?.price})]}),e.jsxs("div",{className:"p-3 border-bottom",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",onClick:()=>J(!c),children:[e.jsx("h6",{className:"fw-semibold",children:l?.data?.product?.name}),e.jsx(V,{size:16,style:{transform:c?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.35s ease"}})]}),e.jsxs("div",{style:{maxHeight:c?200:0,opacity:c?1:0,overflow:"hidden",transition:"all 0.4s ease"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[["Voice Narration","Details"].map((s,a)=>e.jsx("small",{className:` ${s===k?"border-bottom border-dark text-dark mt-2":"text-muted"} px-2`,onClick:()=>oe(s),children:s},a)),e.jsxs("div",{className:"position-relative",children:[e.jsx(be,{size:20,role:"button",onClick:()=>X(!z)}),z&&e.jsxs("div",{className:"dropdown-menu-custom p-3",children:[e.jsx("div",{className:"dropdown-item",children:"View Store"}),e.jsx("div",{className:"dropdown-item",children:"Mute Notifications"}),e.jsx("div",{className:"dropdown-item",children:"Update Price"}),e.jsx("div",{className:"dropdown-item text-danger",children:"Block"}),e.jsx("div",{className:"dropdown-item text-danger",children:"Report"})]})]})]}),k==="Voice Narration"?e.jsxs("div",{children:[e.jsx("div",{className:"voice-wave my-3",onClick:D,children:e.jsxs("div",{className:"d-flex",children:[e.jsx("img",{src:b,alt:"user",className:"rounded-circle me-2",style:{width:30,height:30,objectFit:"cover"}}),r?e.jsx(F,{size:23,className:"text-dark mt-1"}):e.jsx(L,{size:23,className:"text-dark mt-1"}),e.jsx("div",{className:`wave ${r?"playing":""}`,children:P.map((s,a)=>e.jsx("span",{},a))})]})}),e.jsx("audio",{ref:d,src:"/voice-sample.mp3"})]}):e.jsxs(e.Fragment,{children:[e.jsx("h6",{children:"Items Description"}),e.jsx("p",{className:"mt-2",children:l?.data?.product?.description})]}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-8 text-muted small",children:e.jsx("button",{className:"btn btn-primary btn-sm rounded-pill px-4",children:"Buy"})}),e.jsx("div",{className:"col-4",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-6",children:e.jsx(U,{size:25,className:"text-primary",onClick:()=>p(!0)})}),e.jsx("div",{className:"col-6",children:e.jsx(B,{size:30,className:"text-primary"})})]})})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row m-2",children:[e.jsxs("div",{className:"col-8 text-muted small d-flex align-items-center",children:[e.jsx("img",{src:l?.data?.participants[0]?.user?.profilePicture||b,alt:"user",className:"rounded-circle ",style:{width:70,height:70,objectFit:"cover"}}),e.jsxs("div",{className:"ms-1 py-0",children:[e.jsx("h5",{children:l?.data?.participants[0]?.user?.username}),e.jsx("small",{className:"d-block",children:"090887733"}),e.jsx(we,{size:18,className:" pe-1"}),"Lagos, Nigeria"]})]}),e.jsx("div",{className:"col-4",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-6",children:e.jsx(U,{size:25,className:"text-primary",onClick:()=>p(!0)})}),e.jsx("div",{className:"col-6",children:e.jsx(B,{size:30,className:"text-primary"})})]})})]}),e.jsx("hr",{className:"text-mte"}),e.jsxs("div",{children:[e.jsx("div",{className:"voice-wave my-3",onClick:D,children:e.jsxs("div",{className:"d-flex",children:[e.jsx("img",{src:b,alt:"user",className:"rounded-circle me-2",style:{width:30,height:30,objectFit:"cover"}}),r?e.jsx(F,{size:23,className:"text-dark mt-1"}):e.jsx(L,{size:23,className:"text-dark mt-1"}),e.jsx("div",{className:`wave ${r?"playing":""}`,children:P.map((s,a)=>e.jsx("span",{},a))}),e.jsx("small",{className:"text-end text-muted ms-3",children:"7:00Pm"})]})}),e.jsx("audio",{ref:d,src:"/voice-sample.mp3"})]})]}),e.jsx("div",{className:"chat-box p-1",style:{height:`${c?200:500}px`},children:re?.data?.items.map((s,a)=>e.jsxs("div",{className:`chat-msg ${s?.sender?.id===x?.id?"me":""}`,children:[s?.messageType==="VOICE"?e.jsx("audio",{controls:!0,src:s.audio,style:{width:"200px"}}):e.jsx(e.Fragment,{children:s?.content}),e.jsx("small",{className:` ${s?.sender?.id===x?.id?"text-end text-white":"text-start text-muted "} ms-2 d-block`,children:Re(s.createdAt)})]},a))}),e.jsxs("div",{className:"chat-input d-flex justify-content-between align-items-center   border-top mx-3",children:[e.jsx(ve,{size:40,className:`btn ${M?"btn-danger":"btn-primary"} text-white`,style:{width:64,height:50,borderRadius:"50%"},onClick:ue}),e.jsx("button",{className:"btn btn-sm btn-outline-primary rounded-pill px-3 mx-2",children:"Buy"}),e.jsx("input",{className:"form-control form-control-sm rounded-pill",placeholder:"Type a message",value:h,onChange:s=>C(s.target.value)}),e.jsx("button",{className:"btn btn-primary btn-sm ms-2",onClick:()=>{ce()},disabled:v.isPending,children:e.jsx(Ne,{size:16})})]}),O&&e.jsx("div",{className:"call-overlay",children:e.jsxs("div",{className:"call-card",children:[e.jsx("h6",{children:"Calling Sellerâ€¦"}),e.jsx("button",{className:"btn btn-danger mt-3",onClick:()=>p(!1),children:"End Call"})]})})]})}export{Xe as B,Ce as C,Qe as S};
