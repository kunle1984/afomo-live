import{h as A,a as ue,r as a,u as xe,n as he,l as pe,b,j as e,c as ge,M as je,o as ve,e as V,v as Ne,m as w}from"./index-q2ei7gRu.js";import{u as ye,d as B,E as fe,j as U,k as L,l as _,V as q,M as be}from"./Layout-CXZBpNoW.js";const we=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],Se=A("chevron-left",we);const Ce=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],Ke=A("star",Ce),{avatar:S,defaultProduct:ke}=ge,Me=[ke],Te=u=>new Date(u).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}).toLowerCase();function He(){ue();const[u,C]=a.useState(0),{token:k,user:Q}=xe(),h=JSON.parse(Q),[p,M]=a.useState(""),[n,O]=a.useState(!1),[X,g]=a.useState(!1),[T,J]=a.useState("Voice Narration"),[z,E]=a.useState(!1),j=a.useRef(null),v=a.useRef([]),[R,K]=a.useState(!1),[o,H]=a.useState(!1),x=he(),{productId:G,sellerId:W,buyerId:Y}=pe(),[l,Z]=a.useState([]),[i,ee]=a.useState(),[ze,Ee]=a.useState(),[Re,Ie]=a.useState(),I=a.useRef(null),{mutate:se,isPending:Pe,isError:De,error:$e,isFetching:Fe,isSuccess:Ve,data:Be}=b({mutationFn:s=>V.post(Ne,s,{headers:{"Content-Type":"multipart/form-data"}}),onSuccess:s=>{const t=s?.data?.voiceUrl,r=s?.data?.voiceDuration;t&&y.mutate({messageType:"VOICE",voiceUrl:t,voiceDuration:r})},onError:s=>{console.error(" error:",s)}});let N=[];const{mutate:te,isPending:Ue,isError:Le,error:_e,isSuccess:qe,data:d}=b({mutationFn:s=>V.post(`${w}`,s),onSuccess:s=>{console.log(s),ee(s?.data?.id),N=[...s?.data?.product?.images.map(t=>t.url)],console.log(N),Z(s?.data?.product?.images.length>0?N:Me)},onError:s=>{console.log(s)}});a.useEffect(()=>{te({participantIds:[W,Y],productId:G,initialMessage:"Hello"})},[]);const ae=async s=>{const t=await fetch(`https://afomo-xagx.onrender.com/api/${w}${s}/messages`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`}});if(!t.ok)throw new Error("Failed to fetch messages");return t.json()},{data:ie=[],isLoading:Ae,isPending:Qe}=ye({queryKey:["messages",i],queryFn:()=>ae(i),enabled:!!i}),y=b({mutationFn:async s=>{const t=await fetch(`https://afomo-xagx.onrender.com/api/${w}${i}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify(s)});if(!t.ok)throw new Error("Send failed");return t.json()},onMutate:async s=>(await x.cancelQueries({queryKey:["messages",i]}),{previousMessages:x.getQueryData(["messages",i])}),onError:(s,t,r)=>{console.log(s),x.setQueryData(["messages",i],r.previousMessages)},onSuccess:s=>{x.invalidateQueries({queryKey:["messages",i]}),console.log("Server returned:",s)}}),re=()=>{p.trim()&&(y.mutate({content:p,messageType:"TEXT"}),M(""))},ne=s=>J(s),m=a.useRef(null),P=a.useRef(0),D=new Array(26).fill(1),ce=()=>C(s=>(s+1)%l.length),f=()=>C(s=>(s-1+l.length)%l.length),oe=s=>P.current=s.touches[0].clientX,le=s=>{const t=P.current-s.changedTouches[0].clientX;t>50&&ce(),t<-50&&f()},$=()=>{m.current&&(n?m.current.pause():m.current.play(),O(!n))},de=async()=>{if(z){j.current?.state!=="inactive"&&j.current.stop(),E(!1);return}try{const s=await navigator.mediaDevices.getUserMedia({audio:!0});I.current=s;const t=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm",r=new MediaRecorder(s,{mimeType:t});j.current=r,v.current=[],r.ondataavailable=c=>{c.data.size>0&&v.current.push(c.data)},r.onstop=()=>{const c=new Blob(v.current,{type:"audio/webm"});if(console.log("Blob size:",c.size),c.size===0)return;I.current.getTracks().forEach(me=>me.stop());const F={voice:c};console.log(F),se(F)},r.start(200),E(!0)}catch(s){console.log(s),alert("Microphone permission denied")}};return e.jsxs("div",{className:"container px-0",style:{maxWidth:420},children:[h?.accountType==="BUYER"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex align-items-center p-3 border-bottom",children:[e.jsx("button",{className:"btn btn-sm rounded-circle bg-dark ",onClick:f,style:{opacity:.7},children:e.jsx(Se,{size:22,className:"text-white"})}),e.jsx("h6",{className:"fw-bold mb-0 flex-grow-1 text-center",children:"Duplex Store & Boutique"}),e.jsx("button",{className:"btn btn-sm rounded-circle bg-dark ",onClick:f,style:{opacity:.7},children:e.jsx(B,{size:22,className:"text-white"})})]}),e.jsxs("div",{className:"position-relative",onTouchStart:oe,onTouchEnd:le,children:[e.jsx("img",{src:l[u],className:"w-100 carousel-img",alt:""}),e.jsx("div",{className:"carousel-dots",children:l.map((s,t)=>e.jsx("span",{className:t===u?"active":""},t))}),e.jsx("span",{className:"badge bg-primary price-badge",children:d?.data?.product?.price})]}),e.jsxs("div",{className:"p-3 border-bottom",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",onClick:()=>H(!o),children:[e.jsx("h6",{className:"fw-semibold",children:d?.data?.product?.name}),e.jsx(B,{size:16,style:{transform:o?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.35s ease"}})]}),e.jsxs("div",{style:{maxHeight:o?200:0,opacity:o?1:0,overflow:"hidden",transition:"all 0.4s ease"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[["Voice Narration","Details"].map((s,t)=>e.jsx("small",{className:` ${s===T?"border-bottom border-dark text-dark mt-2":"text-muted"} px-2`,onClick:()=>ne(s),children:s},t)),e.jsxs("div",{className:"position-relative",children:[e.jsx(fe,{size:20,role:"button",onClick:()=>K(!R)}),R&&e.jsxs("div",{className:"dropdown-menu-custom p-3",children:[e.jsx("div",{className:"dropdown-item",children:"View Store"}),e.jsx("div",{className:"dropdown-item",children:"Mute Notifications"}),e.jsx("div",{className:"dropdown-item",children:"Update Price"}),e.jsx("div",{className:"dropdown-item text-danger",children:"Block"}),e.jsx("div",{className:"dropdown-item text-danger",children:"Report"})]})]})]}),T==="Voice Narration"?e.jsxs("div",{children:[e.jsx("div",{className:"voice-wave my-3",onClick:$,children:e.jsxs("div",{className:"d-flex",children:[e.jsx("img",{src:S,alt:"user",className:"rounded-circle me-2",style:{width:30,height:30,objectFit:"cover"}}),n?e.jsx(U,{size:23,className:"text-dark mt-1"}):e.jsx(L,{size:23,className:"text-dark mt-1"}),e.jsx("div",{className:`wave ${n?"playing":""}`,children:D.map((s,t)=>e.jsx("span",{},t))})]})}),e.jsx("audio",{ref:m,src:"/voice-sample.mp3"})]}):e.jsxs(e.Fragment,{children:[e.jsx("h6",{children:"Items Description"}),e.jsx("p",{className:"mt-2",children:d?.data?.product?.description})]}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-8 text-muted small",children:e.jsx("button",{className:"btn btn-primary btn-sm rounded-pill px-4",children:"Buy"})}),e.jsx("div",{className:"col-4",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-6",children:e.jsx(_,{size:25,className:"text-primary",onClick:()=>g(!0)})}),e.jsx("div",{className:"col-6",children:e.jsx(q,{size:30,className:"text-primary"})})]})})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row m-2",children:[e.jsxs("div",{className:"col-8 text-muted small d-flex align-items-center",children:[e.jsx("img",{src:d?.data?.participants[0]?.user?.profilePicture||S,alt:"user",className:"rounded-circle ",style:{width:70,height:70,objectFit:"cover"}}),e.jsxs("div",{className:"ms-1 py-0",children:[e.jsx("h5",{children:d?.data?.participants[0]?.user?.username}),e.jsx("small",{className:"d-block",children:"090887733"}),e.jsx(be,{size:18,className:" pe-1"}),"Lagos, Nigeria"]})]}),e.jsx("div",{className:"col-4",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-6",children:e.jsx(_,{size:25,className:"text-primary",onClick:()=>g(!0)})}),e.jsx("div",{className:"col-6",children:e.jsx(q,{size:30,className:"text-primary"})})]})})]}),e.jsx("hr",{className:"text-mte"}),e.jsxs("div",{children:[e.jsx("div",{className:"voice-wave my-3",onClick:$,children:e.jsxs("div",{className:"d-flex",children:[e.jsx("img",{src:S,alt:"user",className:"rounded-circle me-2",style:{width:30,height:30,objectFit:"cover"}}),n?e.jsx(U,{size:23,className:"text-dark mt-1"}):e.jsx(L,{size:23,className:"text-dark mt-1"}),e.jsx("div",{className:`wave ${n?"playing":""}`,children:D.map((s,t)=>e.jsx("span",{},t))}),e.jsx("small",{className:"text-end text-muted ms-3",children:"7:00Pm"})]})}),e.jsx("audio",{ref:m,src:"/voice-sample.mp3"})]})]}),e.jsx("div",{className:"chat-box p-1",style:{height:`${o?200:500}px`},children:ie?.data?.items.map((s,t)=>e.jsxs("div",{className:`chat-msg ${s?.sender?.id===h?.id?"me":""}`,children:[s?.messageType==="VOICE"?e.jsx("audio",{controls:!0,src:s.voiceUrl,style:{width:"200px"}}):s?.content,e.jsx("small",{className:` ${s?.sender?.id===h?.id?"text-end text-white":"text-start text-muted "} ms-2 d-block`,children:Te(s.createdAt)})]},t))}),e.jsxs("div",{className:"chat-input d-flex justify-content-between align-items-center   border-top mx-3",children:[e.jsx(je,{size:40,className:`btn ${z?"btn-danger":"btn-primary"} text-white`,style:{width:64,height:50,borderRadius:"50%"},onClick:de}),e.jsx("button",{className:"btn btn-sm btn-outline-primary rounded-pill px-3 mx-2",children:"Buy"}),e.jsx("input",{className:"form-control form-control-sm rounded-pill",placeholder:"Type a message",value:p,onChange:s=>M(s.target.value)}),e.jsx("button",{className:"btn btn-primary btn-sm ms-2",onClick:()=>{re()},disabled:y.isPending,children:e.jsx(ve,{size:16})})]}),X&&e.jsx("div",{className:"call-overlay",children:e.jsxs("div",{className:"call-card",children:[e.jsx("h6",{children:"Calling Sellerâ€¦"}),e.jsx("button",{className:"btn btn-danger mt-3",onClick:()=>g(!1),children:"End Call"})]})})]})}export{He as B,Se as C,Ke as S};
